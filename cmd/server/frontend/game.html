<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy War Game - View</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
        }
        .game-info {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .game-info p {
            margin: 5px 0;
            font-size: 16px;
        }
        .boards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .board {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 300px;
            flex: 1;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            grid-template-rows: repeat(10, 30px);
            gap: 2px;
            margin-top: 15px;
        }
        .grid-header {
            display: grid;
            grid-template-columns: 30px repeat(10, 30px);
            gap: 2px;
            margin-bottom: 5px;
        }
        .grid-header-item {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .grid-row {
            display: grid;
            grid-template-columns: 30px repeat(10, 30px);
            gap: 2px;
        }
        .grid-row-header {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .cell {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e8f4fc;
            position: relative;
        }
        .cell img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .hit {
            background-color: #ff6b6b !important; /* Red for hit */
        }
        .miss {
            background-color: #ffa94d !important; /* Orange for miss */
        }
        .normal {
            background-color: #8ce99a !important; /* Green for normal */
        }
        .plant-container {
            border: 2px solid transparent;
        }
        .plant-working {
            border-color: #2ecc71 !important; /* Green border for working plants */
        }
        .plant-damaged {
            border-color: #e74c3c !important; /* Red border for damaged plants */
        }
        .button {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 20px;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .home-link {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Energy War Game - View</h1>
    
    <div class="game-info">
        <h2>Game Status</h2>
        <p id="game-id">Game ID: Loading...</p>
        <p id="game-status">Status: Loading...</p>
        <p id="game-turn">Turn: Loading...</p>
        <p id="game-winner">Winner: None</p>
    </div>
    
    <div class="boards-container">
        <div class="board">
            <h3 id="player1-name">Player 1</h3>
            <p id="player1-capacity">Capacity: 0 / 0</p>
            <div id="player1-board"></div>
        </div>
        
        <div class="board">
            <h3 id="player2-name">Player 2</h3>
            <p id="player2-capacity">Capacity: 0 / 0</p>
            <div id="player2-board"></div>
        </div>
    </div>
    
    <div class="home-link">
        <a href="index.html" class="button">Back to Home</a>
    </div>
    
    <script>
        $(document).ready(function() {
            // Get game ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            
            if (!gameId) {
                alert('No game ID provided!');
                window.location.href = 'index.html';
                return;
            }
            
            // Update game ID display
            $('#game-id').text(`Game ID: ${gameId}`);
            
            // Function to create a grid for a player's board
            function createGrid(containerId, size = 10) {
                const container = $(`#${containerId}`);
                container.empty();
                
                // Create grid header (column numbers)
                const gridHeader = $('<div class="grid-header"></div>');
                gridHeader.append('<div class="grid-header-item"></div>'); // Empty corner cell
                
                for (let i = 1; i <= size; i++) {
                    gridHeader.append(`<div class="grid-header-item">${i}</div>`);
                }
                
                container.append(gridHeader);
                
                // Create grid rows
                for (let row = 0; row < size; row++) {
                    const gridRow = $('<div class="grid-row"></div>');
                    
                    // Row header (letters A-J)
                    gridRow.append(`<div class="grid-row-header">${String.fromCharCode(65 + row)}</div>`);
                    
                    // Cells
                    for (let col = 0; col < size; col++) {
                        gridRow.append(`<div class="cell" data-coord="${String.fromCharCode(65 + row)}${col + 1}"></div>`);
                    }
                    
                    container.append(gridRow);
                }
            }
            
            // Create initial grids
            createGrid('player1-board');
            createGrid('player2-board');
            
            // Function to update the board display
            function updateBoard(playerId, playerName, board) {
                // Update player name and capacity
                $(`#${playerId}-name`).text(playerName);
                $(`#${playerId}-capacity`).text(`Capacity: ${board.capacity} / ${board.total_capacity}`);
                
                // Clear all cell classes and images
                $(`#${playerId}-board .cell`).removeClass('hit miss normal').empty();
                
                // Reset all plant containers
                $('.plant-container').removeClass('plant-container plant-working plant-damaged');
                
                // Create a map of coordinates to plant types
                const plantMap = {};
                const plantCells = {};
                
                // Process plants
                if (board.plants) {
                    board.plants.forEach(plant => {
                        const plantType = plant.type.toLowerCase();
                        const plantCoords = [];
                        
                        plant.coordinates.forEach(coord => {
                            plantMap[coord] = plantType;
                            plantCoords.push(coord);
                        });
                        
                        plantCells[plantType] = plantCells[plantType] || [];
                        plantCells[plantType].push(plantCoords);
                    });
                }
                
                // Add plant images to cells
                for (const [coord, plantType] of Object.entries(plantMap)) {
                    const cell = $(`#${playerId}-board .cell[data-coord="${coord}"]`);
                    cell.html(`<img src="assets/img/${plantType}.png" alt="${plantType}">`);
                    cell.addClass('normal');
                }
                
                // Mark hits
                if (board.hits) {
                    board.hits.forEach(coord => {
                        const cell = $(`#${playerId}-board .cell[data-coord="${coord}"]`);
                        cell.addClass('hit').removeClass('normal');
                    });
                }
                
                // Mark misses
                if (board.misses) {
                    board.misses.forEach(coord => {
                        const cell = $(`#${playerId}-board .cell[data-coord="${coord}"]`);
                        cell.addClass('miss').removeClass('normal');
                    });
                }
                
                // Group cells by plant and add container with appropriate status
                for (const [plantType, plantGroups] of Object.entries(plantCells)) {
                    plantGroups.forEach(plantCoords => {
                        // Check if any cell in this plant is hit
                        const isHit = board.hits && plantCoords.some(coord => board.hits.includes(coord));
                        
                        // Create a container for this plant
                        const firstCell = $(`#${playerId}-board .cell[data-coord="${plantCoords[0]}"]`);
                        const lastCell = $(`#${playerId}-board .cell[data-coord="${plantCoords[plantCoords.length - 1]}"]`);
                        
                        // Add plant container class to all cells in this plant
                        plantCoords.forEach(coord => {
                            const cell = $(`#${playerId}-board .cell[data-coord="${coord}"]`);
                            cell.addClass('plant-container');
                            
                            if (isHit) {
                                cell.addClass('plant-damaged');
                            } else {
                                cell.addClass('plant-working');
                            }
                        });
                    });
                }
            }
            
            // Function to fetch game data and update the UI
            function updateGameData() {
                $.ajax({
                    url: `/api/games/${gameId}`,
                    type: 'GET',
                    success: function(gameData) {
                        // Update game status information
                        $('#game-status').text(`Status: ${gameData.status}`);
                        $('#game-turn').text(`Turn: ${gameData.turn || 'N/A'}`);
                        $('#game-winner').text(`Winner: ${gameData.winner || 'None'}`);
                        
                        // Get player names
                        const playerNames = Object.keys(gameData.players);
                        
                        if (playerNames.length >= 2) {
                            const player1 = playerNames[0];
                            const player2 = playerNames[1];
                            
                            // Fetch boards for both players
                            fetchPlayerBoard(player1, 'player1-board');
                            fetchPlayerBoard(player2, 'player2-board');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error fetching game data:', xhr);
                    }
                });
            }
            
            // Function to fetch a player's board
            function fetchPlayerBoard(playerName, containerId) {
                $.ajax({
                    url: `/api/games/${gameId}/opponent/${playerName}/board`,
                    type: 'GET',
                    success: function(boardData) {
                        // Extract player ID from container ID
                        const playerId = containerId.split('-')[0];
                        
                        // Update the board display
                        updateBoard(playerId, playerName, boardData);
                    },
                    error: function(xhr) {
                        console.error(`Error fetching board for ${playerName}:`, xhr);
                    }
                });
            }
            
            // Initial update
            updateGameData();
            
            // Set up polling every second
            setInterval(updateGameData, 1000);
        });
    </script>
</body>
</html>
